# Segrom.JobObserver

Telegram-бот для получения уведомлений о новых вакансиях от крупных ecom компаний.

## Возможности
- Периодический сбор вакансий с открытых API компаний.
- Уведомления в Telegram-чатах о новых вакансиях.
- Обновление сообщений при изменении существующих вакансий.
- Инициализация новых чатов с текущими вакансиями.

## Архитектура
- **ozon-vacancy-service**: Получает вакансии с API Ozon, сохраняет их в PostgreSQL и публикует события в Kafka.
- **telegram-bot**: Обрабатывает события из Kafka и отправляет уведомления через Telegram.
- **Kafka**: Используется для обмена сообщениями между сервисами.
- **PostgreSQL**: Хранит данные о вакансиях и сообщениях.
- **Мониторинг**: Prometheus, Grafana и Graylog для отслеживания работы системы.

## Требования
- Установленные Docker и Docker Compose.
- Токен Telegram-бота, полученный через [BotFather](https://t.me/BotFather).

## Установка
1. Клонируйте репозиторий:

   ```sh
   git clone https://github.com/segrom/Segrom.JobObserver.git
   ```

2. Создайте файл `.env` в корневой директории и настройте переменные окружения. Пример переменных:

   ```
   TG_BOT_TOKEN=your_bot_token_here
   POSTGRES_USER=your_postgres_user
   POSTGRES_PASSWORD=your_postgres_password
   BOT_DB_NAME=bot_db
   BOT_DB_PASS=bot_db_password
   OZON_VACANCY_DB_NAME=ozon_vacancy_db
   OZON_VACANCY_DB_PASS=ozon_vacancy_db_password
   GRAYLOG_HOST=graylog
   GRAYLOG_PORT=12201
   KAFKA_0_EXTERNAL_PORT=9092
   ```

   Полный список переменных смотрите в файле `docker-compose.yml`.

3. Запустите сервисы с помощью Docker Compose:

   ```sh
   docker-compose up -d
   ```

4. Взаимодействуйте с Telegram-ботом, чтобы подписаться на уведомления о вакансиях.

## Использование
После запуска сервисов бот автоматически собирает новые вакансии и уведомляет подписанные чаты. Для инициализации нового чата используйте соответствующую команду бота (если она реализована). Подробности о командах бота уточняйте в документации или коде.

## Технологии
- **.NET Core**: Основа для сервисов ozon-vacancy-service и telegram-bot.
- **PostgreSQL**: Хранение данных о вакансиях и сообщениях.
- **Kafka**: Обмен сообщениями между сервисами.
- **Docker**: Контейнеризация сервисов.
- **Prometheus, Grafana, Graylog**: Мониторинг и логирование.

## Структура проекта
| Компонент | Описание |
|-----------|----------|
| `ozon-vacancy-service` | Сервис для получения вакансий с API Ozon, хранения в базе и публикации событий в Kafka. |
| `telegram-bot` | Сервис для обработки событий из Kafka и отправки уведомлений в Telegram. |
| `Kafka` | Брокер сообщений для асинхронного взаимодействия сервисов. |
| `PostgreSQL` | Две базы данных: одна для вакансий, другая для сообщений бота. |
| `Мониторинг` | Prometheus для метрик, Grafana для визуализации, Graylog для логов. |

## Конфигурация
Файл `docker-compose.yml` определяет сервисы и их зависимости. Основные переменные окружения включают:

| Переменная | Описание |
|------------|----------|
| `TG_BOT_TOKEN` | Токен Telegram-бота. |
| `POSTGRES_USER` | Пользователь для PostgreSQL. |
| `POSTGRES_PASSWORD` | Пароль для PostgreSQL. |
| `BOT_DB_NAME` | Имя базы данных для бота. |
| `OZON_VACANCY_DB_NAME` | Имя базы данных для вакансий. |
| `GRAYLOG_HOST` | Хост для Graylog. |
| `KAFKA_0_EXTERNAL_PORT` | Порт для Kafka. |

Для полной настройки проверьте `docker-compose.yml` и настройте `.env` соответственно.

## Как это работает
1. **ozon-vacancy-service**:
    - Периодически вызывает открытое API Ozon для получения актуальных вакансий.
    - Сохраняет данные в PostgreSQL.
    - Публикует события о новых или обновленных вакансиях в Kafka.

2. **telegram-bot**:
    - Слушает события из Kafka через `VacancyNewConsumer` и `VacancyUpdateConsumer`.
    - Отправляет уведомления в Telegram-чаты с помощью `BotService`.
    - Сохраняет сообщения в базе данных для отслеживания.

3. **Мониторинг**:
    - Prometheus собирает метрики, такие как количество вызовов API или созданных вакансий.
    - Grafana визуализирует метрики.
    - Graylog хранит логи для отладки.

## Планируемые улучшения
- [ ] Добавить документацию по командам Telegram-бота
- [ ] Реализовать подписки по тегам технологий, опыта и пр.
- [ ] Добавить новые источники вакансий
- [ ] Расширить мониторинг с дополнительными метриками